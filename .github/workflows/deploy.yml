- name: Remote deploy (sanitized, local expansion)
  run: |
    # sanitize runner-side values first
    EC2_USER_RAW="${{ secrets.EC2_USER }}"
    EC2_HOST_RAW="${{ secrets.EC2_HOST }}"
    EC2_DIR_RAW="${{ secrets.EC2_DIR }}"
    DEPLOY_BRANCH_RAW="${{ env.DEPLOY_BRANCH }}"

    EC2_USER=$(printf "%s" "$EC2_USER_RAW" | tr -d '\r\n' | awk '{$1=$1;print}')
    EC2_HOST=$(printf "%s" "$EC2_HOST_RAW" | tr -d '\r\n' | awk '{$1=$1;print}')
    EC2_DIR=$(printf "%s" "$EC2_DIR_RAW" | tr -d '\r\n' | awk '{$1=$1;print}')
    DEPLOY_BRANCH=$(printf "%s" "$DEPLOY_BRANCH_RAW" | tr -d '\r\n' | awk '{$1=$1;print}')

    echo "Deploying to ${EC2_USER}@${EC2_HOST} : ${EC2_DIR} (branch ${DEPLOY_BRANCH})"

    # NOTE: heredoc is NOT single-quoted so local $EC2_DIR and $DEPLOY_BRANCH are expanded into the content
    ssh -o StrictHostKeyChecking=no -i ~/.ssh/ec2_key.pem "${EC2_USER}@${EC2_HOST}" <<SSH_EOF
      set -euo pipefail

      # use expanded values substituted by the runner into this heredoc
      cd "${EC2_DIR:-/home/ubuntu}" || { echo "DEPLOY DIR not found: ${EC2_DIR}"; exit 2; }

      git fetch --all --prune
      git checkout "${DEPLOY_BRANCH:-main}"
      git reset --hard "origin/${DEPLOY_BRANCH:-main}"

      if [ -f "venv/bin/activate" ]; then
        . venv/bin/activate
      fi

      if [ -f requirements.txt ]; then
        pip install -r requirements.txt
      fi

      if [ -f manage.py ]; then
        python manage.py migrate --noinput || true
        python manage.py collectstatic --noinput || true
      fi

      sudo systemctl restart gunicorn || echo "gunicorn restart failed or not installed"
      sudo systemctl restart nginx || echo "nginx restart failed or not installed"

      echo "DEPLOY: finished successfully on \$(hostname) as \$(whoami)"
SSH_EOF
